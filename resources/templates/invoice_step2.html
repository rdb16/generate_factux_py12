{% extends "base.html" %}

{% block title %}Nouvelle facture - Lignes{% endblock %}

{% block steps %}
                <div class="step completed">
                    <span class="number">&#10003;</span>
                    Informations
                </div>
                <div class="step-divider"></div>
                <div class="step active">
                    <span class="number">2</span>
                    Lignes
                </div>
                <div class="step-divider"></div>
                <div class="step">
                    <span class="number">3</span>
                    Recapitulatif
                </div>
{% endblock %}

{% block extra_styles %}
            /* Resume */
            .summary {
                background: #f8fafc;
                padding: 20px 30px;
                border-bottom: 1px solid #e2e8f0;
                display: grid;
                grid-template-columns: 1fr 1fr 1fr;
                gap: 30px;
            }
            .summary-section h3 {
                font-size: 12px;
                font-weight: 600;
                color: #667eea;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                margin: 0 0 12px 0;
            }
            .summary-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 8px 20px;
            }
            .summary-item {
                font-size: 13px;
            }
            .summary-item .label {
                color: #718096;
            }
            .summary-item .value {
                color: #1a202c;
                font-weight: 500;
            }
            .btn-modify {
                font-size: 12px;
                color: #667eea;
                background: none;
                border: 1px solid #667eea;
                padding: 4px 12px;
                border-radius: 4px;
                cursor: pointer;
                margin-left: 10px;
            }
            .btn-modify:hover {
                background: #667eea;
                color: white;
            }

            /* Contenu principal */
            .main-content {
                padding: 30px;
            }
            .section-title {
                font-size: 16px;
                font-weight: 600;
                color: #1a1a2e;
                margin: 0 0 20px 0;
            }

            /* Lignes */
            .lines-header {
                display: grid;
                grid-template-columns: 3fr 100px 120px 80px 120px 80px;
                gap: 12px;
                padding: 12px 16px;
                background: #edf2f7;
                border-radius: 8px 8px 0 0;
                font-size: 11px;
                font-weight: 600;
                color: #4a5568;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }
            .lines-container {
                border: 1px solid #e2e8f0;
                border-radius: 8px;
                overflow: hidden;
            }
            .line {
                display: grid;
                grid-template-columns: 3fr 100px 120px 80px 120px 80px;
                gap: 12px;
                padding: 12px 16px;
                border-bottom: 1px solid #e2e8f0;
                align-items: center;
                background: white;
            }
            .line:last-child {
                border-bottom: none;
            }
            .line:hover {
                background: #f8fafc;
            }
            .line.error {
                background: #fff5f5;
                border-color: #feb2b2;
            }
            .line input,
            .line select {
                width: 100%;
                padding: 10px 12px;
                border: 1px solid #e2e8f0;
                border-radius: 6px;
                font-size: 14px;
                background: white;
            }
            .line input:focus,
            .line select:focus {
                outline: none;
                border-color: #667eea;
                box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
            }
            .line input.error,
            .line select.error {
                border-color: #e53e3e;
            }
            .line input[type="number"] {
                text-align: right;
            }
            .line .line-total {
                font-weight: 600;
                color: #1a202c;
                text-align: right;
                padding-right: 8px;
            }
            .line .btn-remove {
                padding: 8px 12px;
                background: #fff5f5;
                color: #c53030;
                border: 1px solid #feb2b2;
                border-radius: 6px;
                cursor: pointer;
                font-size: 13px;
                transition: all 0.2s;
            }
            .line .btn-remove:hover {
                background: #fed7d7;
            }

            /* Ligne wrapper pour inclure le rabais */
            .line-wrapper {
                border-bottom: 1px solid #e2e8f0;
            }
            .line-wrapper:last-child {
                border-bottom: none;
            }
            .line-wrapper .line {
                border-bottom: none;
            }

            /* Rabais */
            .discount-toggle {
                font-size: 11px;
                color: #667eea;
                background: none;
                border: none;
                cursor: pointer;
                padding: 4px 8px;
                margin-left: 8px;
                border-radius: 4px;
            }
            .discount-toggle:hover {
                background: #eef2ff;
            }
            .discount-row {
                display: none;
                padding: 8px 16px 12px 16px;
                background: #fafbfc;
                border-top: 1px dashed #e2e8f0;
                align-items: center;
                gap: 12px;
            }
            .discount-row.visible {
                display: flex;
            }
            .discount-row .discount-label {
                font-size: 12px;
                color: #718096;
                white-space: nowrap;
            }
            .discount-row input,
            .discount-row select {
                padding: 6px 10px;
                border: 1px solid #e2e8f0;
                border-radius: 4px;
                font-size: 13px;
                background: white;
            }
            .discount-row input {
                width: 100px;
                text-align: right;
            }
            .discount-row select {
                width: 80px;
            }
            .discount-row input:focus,
            .discount-row select:focus {
                outline: none;
                border-color: #667eea;
            }
            .discount-row .discount-amount {
                font-size: 12px;
                color: #c53030;
                font-weight: 500;
                min-width: 80px;
            }
            .discount-row .btn-clear-discount {
                font-size: 11px;
                color: #a0aec0;
                background: none;
                border: none;
                cursor: pointer;
                padding: 4px;
            }
            .discount-row .btn-clear-discount:hover {
                color: #c53030;
            }

            /* TVA 0% : categorie et exoneration */
            .vat-extra-row {
                display: none;
                padding: 8px 16px 12px 16px;
                background: #fffff0;
                border-top: 1px dashed #e2e8f0;
                align-items: center;
                gap: 12px;
                flex-wrap: wrap;
            }
            .vat-extra-row.visible {
                display: flex;
            }
            .vat-extra-row .vat-extra-label {
                font-size: 12px;
                color: #718096;
                white-space: nowrap;
            }
            .vat-extra-row select,
            .vat-extra-row input[type="text"] {
                padding: 6px 10px;
                border: 1px solid #e2e8f0;
                border-radius: 4px;
                font-size: 13px;
                background: white;
            }
            .vat-extra-row select:focus,
            .vat-extra-row input[type="text"]:focus {
                outline: none;
                border-color: #667eea;
            }
            .vat-extra-row select.category-select {
                width: 220px;
            }
            .vat-extra-row select.vatex-select {
                width: 280px;
            }
            .vat-extra-row input.reason-input {
                flex: 1;
                min-width: 200px;
            }

            /* Boutons */
            .actions-row {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-top: 20px;
            }

            /* Recapitulatif et Totaux */
            .invoice-summary {
                margin-top: 24px;
                background: #f8fafc;
                border-radius: 8px;
                overflow: hidden;
                border: 1px solid #e2e8f0;
            }
            .vat-breakdown {
                padding: 16px 20px;
                border-bottom: 1px solid #e2e8f0;
            }
            .vat-breakdown-title {
                font-size: 11px;
                font-weight: 600;
                color: #667eea;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                margin-bottom: 12px;
            }
            .vat-table {
                width: 100%;
                border-collapse: collapse;
                font-size: 13px;
            }
            .vat-table th {
                text-align: left;
                padding: 8px 12px;
                background: #edf2f7;
                color: #4a5568;
                font-weight: 600;
                font-size: 11px;
                text-transform: uppercase;
                letter-spacing: 0.3px;
            }
            .vat-table th:not(:first-child) {
                text-align: right;
            }
            .vat-table td {
                padding: 10px 12px;
                border-bottom: 1px solid #e2e8f0;
                color: #1a202c;
            }
            .vat-table td:not(:first-child) {
                text-align: right;
                font-variant-numeric: tabular-nums;
            }
            .vat-table tr:last-child td {
                border-bottom: none;
            }
            .vat-table .vat-rate {
                font-weight: 500;
            }
            .vat-table-empty {
                color: #a0aec0;
                font-style: italic;
                padding: 12px;
                text-align: center;
            }
            .totals-section {
                padding: 16px 20px;
                background: white;
            }
            .totals-grid {
                display: flex;
                flex-direction: column;
                align-items: flex-end;
                gap: 6px;
            }
            .totals-row {
                display: flex;
                justify-content: flex-end;
                gap: 30px;
                min-width: 280px;
            }
            .totals-row .label {
                color: #718096;
                font-size: 14px;
            }
            .totals-row .value {
                font-size: 14px;
                font-weight: 500;
                color: #1a202c;
                min-width: 120px;
                text-align: right;
                font-variant-numeric: tabular-nums;
            }
            .totals-row.total-ttc {
                margin-top: 8px;
                padding-top: 12px;
                border-top: 2px solid #e2e8f0;
            }
            .totals-row.total-ttc .label {
                font-size: 16px;
                font-weight: 600;
                color: #1a202c;
            }
            .totals-row.total-ttc .value {
                font-size: 18px;
                font-weight: 700;
                color: #667eea;
            }

            /* Messages */
            .success-container {
                background: #f0fff4;
                border-left: 4px solid #38a169;
                color: #276749;
                padding: 16px 20px;
                margin: 20px 30px;
                border-radius: 0 8px 8px 0;
                display: none;
            }

            @media (max-width: 1200px) {
                .summary {
                    grid-template-columns: 1fr;
                }
            }
            @media (max-width: 900px) {
                .lines-header {
                    display: none;
                }
                .line {
                    grid-template-columns: 1fr 1fr;
                    gap: 10px;
                }
                .line > *:first-child {
                    grid-column: 1 / -1;
                }
            }
{% endblock %}

{% block before_content %}
            <div class="summary">
                <div class="summary-section">
                    <h3>
                        Facture
                        <button
                            class="btn-modify"
                            onclick="window.location.href = '/'"
                        >
                            Modifier
                        </button>
                    </h3>
                    <div class="summary-grid">
                        <div class="summary-item">
                            <span class="label">Numero : </span>
                            <span class="value" id="sum-invoice-number"
                                >{{ invoice.invoice_number }}</span
                            >
                        </div>
                        <div class="summary-item">
                            <span class="label">Type : </span>
                            <span class="value" id="sum-type"
                                >{{ invoice.type_label }}</span
                            >
                        </div>
                        <div class="summary-item">
                            <span class="label">Date : </span>
                            <span class="value" id="sum-issue-date"
                                >{{ invoice.issue_date_display }}</span
                            >
                        </div>
                        <div class="summary-item">
                            <span class="label">Echeance : </span>
                            <span class="value" id="sum-due-date"
                                >{{ invoice.due_date_display | default("-")
                                }}</span
                            >
                        </div>
                        <div class="summary-item">
                            <span class="label">Devise : </span>
                            <span class="value" id="sum-currency"
                                >{{ invoice.currency_code }}</span
                            >
                        </div>
                        {% if emitter.iban %}
                        <div class="summary-item" style="grid-column: 1 / -1">
                            <span class="value"><em>En votre aimable r&egrave;glement par virement bancaire au {{ emitter.iban }}.</em></span>
                        </div>
                        {% endif %}
                    </div>
                </div>
                <div class="summary-section">
                    <h3>Emetteur</h3>
                    <div class="summary-grid">
                        <div class="summary-item" style="grid-column: 1 / -1">
                            <span class="label">Nom : </span>
                            <span class="value">{{ emitter.name }}{% if emitter.legal_form %} ({{ emitter.legal_form }}){% endif %}</span>
                        </div>
                        <div class="summary-item">
                            <span class="label">SIRET : </span>
                            <span class="value">{{ emitter.siret }}</span>
                        </div>
                        <div class="summary-item">
                            <span class="label">Pays : </span>
                            <span class="value">{{ emitter.country_code }}</span>
                        </div>
                        {% if emitter.address or emitter.city %}
                        <div class="summary-item" style="grid-column: 1 / -1; font-size: 13px;">
                            <span class="label">Adresse : </span>
                            <span class="value">
                                {{ emitter.address or '' }}
                                {% if emitter.postal_code or emitter.city %}
                                    {% if emitter.address %}, {% endif %}
                                    {{ emitter.postal_code or '' }}
                                    {{ emitter.city or '' }}
                                {% endif %}
                            </span>
                        </div>
                        {% endif %}
                    </div>
                </div>
                <div class="summary-section">
                    <h3>Client</h3>
                    <div class="summary-grid">
                        <div class="summary-item" style="grid-column: 1 / -1">
                            <span class="label">Nom : </span>
                            <span class="value" id="sum-recipient-name"
                                >{{ invoice.recipient_name }}</span
                            >
                        </div>
                        <div class="summary-item">
                            <span class="label">SIRET : </span>
                            <span class="value" id="sum-recipient-siret"
                                >{{ invoice.recipient_siret }}</span
                            >
                        </div>
                        <div class="summary-item">
                            <span class="label">Pays : </span>
                            <span class="value" id="sum-recipient-country"
                                >{{ invoice.recipient_country_code }}</span
                            >
                        </div>
                        {% if invoice.recipient_address or invoice.recipient_city %}
                        <div class="summary-item" style="grid-column: 1 / -1; font-size: 13px;">
                            <span class="label">Adresse : </span>
                            <span class="value">
                                {{ invoice.recipient_address or '' }}
                                {% if invoice.recipient_postal_code or invoice.recipient_city %}
                                    {% if invoice.recipient_address %}, {% endif %}
                                    {{ invoice.recipient_postal_code or '' }}
                                    {{ invoice.recipient_city or '' }}
                                {% endif %}
                            </span>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
{% endblock %}

{% block content %}
            <div id="successContainer" class="success-container">
                <p id="successMessage"></p>
            </div>

            <form id="invoiceForm" class="main-content">
                <h2 class="section-title">Lignes de facturation</h2>
                <div class="field-error" data-field="lines"></div>

                <div class="lines-container">
                    <div class="lines-header">
                        <div>Description</div>
                        <div>Quantite</div>
                        <div>Prix unitaire HT</div>
                        <div>TVA %</div>
                        <div>Total HT</div>
                        <div></div>
                    </div>
                    <div id="lines">
                        <div class="line-wrapper" data-id="0">
                            <div class="line">
                                <div style="display: flex; align-items: center">
                                    <input
                                        name="lines[0][description]"
                                        placeholder="Description du produit ou service"
                                        style="flex: 1"
                                        oninput="updateSubmitButton()"
                                    />
                                    <button
                                        type="button"
                                        class="discount-toggle"
                                        onclick="toggleDiscount(this)"
                                    >
                                        + Rabais
                                    </button>
                                </div>
                                <input
                                    name="lines[0][quantity]"
                                    type="number"
                                    step="0.01"
                                    min="0.01"
                                    placeholder="1"
                                    onchange="updateLineTotal(this)"
                                />
                                <input
                                    name="lines[0][unit_price_ht]"
                                    type="number"
                                    step="0.01"
                                    min="0.01"
                                    placeholder="0.00"
                                    onchange="updateLineTotal(this)"
                                />
                                <select
                                    name="lines[0][vat_rate]"
                                    onchange="onVatRateChange(this)"
                                >
                                    <option value="0">0 %</option>
                                    <option value="5.5">5,5 %</option>
                                    <option value="10">10 %</option>
                                    <option value="20" selected>20 %</option>
                                </select>
                                <div class="line-total" data-line="0">
                                    0.00 {{ invoice.currency_code }}
                                </div>
                                <button
                                    type="button"
                                    class="btn-remove"
                                    onclick="removeLine(this)"
                                >
                                    Supprimer
                                </button>
                            </div>
                            <div class="discount-row">
                                <span class="discount-label"
                                    >Rabais sur la ligne ci-dessus :</span
                                >
                                <input
                                    name="lines[0][discount_value]"
                                    type="number"
                                    step="0.01"
                                    min="0"
                                    placeholder="0"
                                    onchange="updateLineTotal(this)"
                                />
                                <select
                                    name="lines[0][discount_type]"
                                    onchange="updateLineTotal(this)"
                                >
                                    <option value="percent">%</option>
                                    <option value="amount">
                                        {{ invoice.currency_code }}
                                    </option>
                                </select>
                                <span
                                    class="discount-amount"
                                    data-discount="0"
                                ></span>
                                <button
                                    type="button"
                                    class="btn-clear-discount"
                                    onclick="clearDiscount(this)"
                                    title="Supprimer le rabais"
                                >
                                    &#10005;
                                </button>
                            </div>
                            <div class="vat-extra-row">
                                <span class="vat-extra-label">Categorie TVA :</span>
                                <select name="lines[0][vat_category]" class="category-select" onchange="onCategoryChange(this)">
                                    <option value="Z">Z - Taux zero</option>
                                    <option value="E">E - Exonere de TVA</option>
                                    <option value="AE">AE - Autoliquidation</option>
                                    <option value="G">G - Export hors UE</option>
                                    <option value="K">K - Intracommunautaire</option>
                                    <option value="O">O - Hors champ TVA</option>
                                </select>
                                <select name="lines[0][vat_exemption_code]" class="vatex-select" style="display:none;" onchange="onVatexChange(this)">
                                    <option value="">-- Code VATEX --</option>
                                </select>
                                <input type="text" name="lines[0][vat_exemption_reason]" class="reason-input" placeholder="Motif d'exoneration" style="display:none;" />
                            </div>
                        </div>
                    </div>
                </div>

                <div class="actions-row">
                    <button
                        type="button"
                        class="btn btn-secondary"
                        onclick="addLine()"
                    >
                        + Ajouter une ligne
                    </button>
                </div>

                <div class="invoice-summary">
                    <div class="vat-breakdown">
                        <div class="vat-breakdown-title">
                            Recapitulatif par taux de TVA
                        </div>
                        <table class="vat-table">
                            <thead>
                                <tr>
                                    <th>Taux</th>
                                    <th>Base HT</th>
                                    <th>Montant TVA</th>
                                </tr>
                            </thead>
                            <tbody id="vat-breakdown-body">
                                <tr>
                                    <td colspan="3" class="vat-table-empty">
                                        Aucune ligne saisie
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="totals-section">
                        <div class="totals-grid">
                            <div class="totals-row">
                                <span class="label">Total HT</span>
                                <span class="value" id="total-ht"
                                    >0.00 {{ invoice.currency_code }}</span
                                >
                            </div>
                            <div class="totals-row">
                                <span class="label">Total TVA</span>
                                <span class="value" id="total-vat"
                                    >0.00 {{ invoice.currency_code }}</span
                                >
                            </div>
                            <div class="totals-row total-ttc">
                                <span class="label">Total TTC</span>
                                <span class="value" id="total-ttc"
                                    >0.00 {{ invoice.currency_code }}</span
                                >
                            </div>
                        </div>
                    </div>
                </div>

                <div
                    class="actions-row"
                    style="
                        justify-content: flex-end;
                        margin-top: 30px;
                        padding-top: 20px;
                        border-top: 1px solid #e2e8f0;
                    "
                >
                    <span id="submitWrapper" style="display: inline-block; cursor: not-allowed;" title="Une ligne est obligatoire !!!">
                        <button type="submit" class="btn btn-primary" id="btnSubmit" disabled style="pointer-events: none; opacity: 0.5;">
                            Generer la facture Factur-X
                        </button>
                    </span>
                </div>
            </form>
{% endblock %}

{% block scripts %}
        <script>
            let lineCount = 1;
            const currency = "{{ invoice.currency_code }}";

            // Codes VATEX par categorie
            const VATEX_CODES = {
                'E': [
                    { code: 'VATEX-EU-132', label: "Activites d'interet public (art. 132)" },
                    { code: 'VATEX-EU-132-1B', label: 'Soins medicaux (art. 132-1b)' },
                    { code: 'VATEX-EU-132-1I', label: 'Enseignement (art. 132-1i)' },
                    { code: 'VATEX-FR-FRANCHISE', label: 'Franchise en base de TVA' },
                    { code: 'VATEX-FR-CNWVAT', label: 'Avoir sans TVA' },
                ],
                'AE': [
                    { code: 'VATEX-EU-AE', label: 'Reverse charge UE (art. 194/196)' },
                    { code: 'VATEX-FR-AE', label: 'Autoliquidation art. 283-2 CGI' },
                ],
                'G': [
                    { code: 'VATEX-EU-G', label: 'Export hors UE (art. 146/147/148)' },
                    { code: 'VATEX-FR-CGI275', label: 'Export art. 275 CGI' },
                ],
                'K': [
                    { code: 'VATEX-EU-IC', label: 'Livraison intracommunautaire (art. 138)' },
                ],
                'O': [
                    { code: 'VATEX-EU-O', label: 'Hors champ TVA' },
                ],
            };

            function onVatRateChange(select) {
                const wrapper = select.closest('.line-wrapper');
                const vatExtra = wrapper.querySelector('.vat-extra-row');
                const rate = parseFloat(select.value) || 0;

                if (rate === 0) {
                    vatExtra.classList.add('visible');
                    const catSelect = wrapper.querySelector('.category-select');
                    catSelect.value = 'Z';
                    onCategoryChange(catSelect);
                } else {
                    vatExtra.classList.remove('visible');
                    wrapper.querySelector('.category-select').value = 'Z';
                    const vatexSelect = wrapper.querySelector('.vatex-select');
                    vatexSelect.style.display = 'none';
                    vatexSelect.value = '';
                    const reasonInput = wrapper.querySelector('.reason-input');
                    reasonInput.style.display = 'none';
                    reasonInput.value = '';
                }
                updateLineTotal(select);
            }

            function onCategoryChange(select) {
                const wrapper = select.closest('.line-wrapper');
                const category = select.value;
                const vatexSelect = wrapper.querySelector('.vatex-select');
                const reasonInput = wrapper.querySelector('.reason-input');

                if (category === 'Z') {
                    vatexSelect.style.display = 'none';
                    vatexSelect.value = '';
                    reasonInput.style.display = 'none';
                    reasonInput.value = '';
                } else {
                    vatexSelect.innerHTML = '<option value="">-- Code VATEX --</option>';
                    const codes = VATEX_CODES[category] || [];
                    codes.forEach(item => {
                        const opt = document.createElement('option');
                        opt.value = item.code;
                        opt.textContent = item.code + ' - ' + item.label;
                        vatexSelect.appendChild(opt);
                    });
                    vatexSelect.style.display = '';
                    reasonInput.style.display = '';
                    reasonInput.value = '';
                }
                updateTotals();
            }

            function onVatexChange(select) {
                const wrapper = select.closest('.line-wrapper');
                const reasonInput = wrapper.querySelector('.reason-input');
                const code = select.value;
                const category = wrapper.querySelector('.category-select').value;
                const codes = VATEX_CODES[category] || [];
                const found = codes.find(c => c.code === code);
                if (found) {
                    reasonInput.value = found.label;
                }
            }

            function validateExistingLines() {
                const errors = [];
                document
                    .querySelectorAll(".line-wrapper")
                    .forEach((wrapper, index) => {
                        const description = wrapper
                            .querySelector('[name*="description"]')
                            .value.trim();
                        const quantity =
                            wrapper.querySelector('[name*="quantity"]').value;
                        const unitPrice = wrapper.querySelector(
                            '[name*="unit_price_ht"]',
                        ).value;

                        const lineNum = index + 1;

                        if (!description) {
                            errors.push(
                                `Ligne ${lineNum} : la description est obligatoire`,
                            );
                            wrapper
                                .querySelector('[name*="description"]')
                                .classList.add("error");
                        }
                        if (!quantity || parseFloat(quantity) <= 0) {
                            errors.push(
                                `Ligne ${lineNum} : la quantite doit etre superieure a 0`,
                            );
                            wrapper
                                .querySelector('[name*="quantity"]')
                                .classList.add("error");
                        }
                        if (!unitPrice || parseFloat(unitPrice) <= 0) {
                            errors.push(
                                `Ligne ${lineNum} : le prix unitaire doit etre superieur a 0`,
                            );
                            wrapper
                                .querySelector('[name*="unit_price_ht"]')
                                .classList.add("error");
                        }
                    });
                return errors;
            }

            function addLine() {
                document
                    .querySelectorAll(".line-wrapper input.error")
                    .forEach((el) => el.classList.remove("error"));
                const errors = validateExistingLines();
                if (errors.length > 0) {
                    alert(
                        "Veuillez completer les lignes existantes avant d'en ajouter une nouvelle :\n\n" +
                            errors.join("\n"),
                    );
                    return;
                }

                const lines = document.getElementById("lines");
                const newIndex = lineCount++;

                const lineHtml = `
                    <div class="line-wrapper" data-id="${newIndex}">
                        <div class="line">
                            <div style="display: flex; align-items: center;">
                                <input
                                    name="lines[${newIndex}][description]"
                                    placeholder="Description du produit ou service"
                                    style="flex: 1;"
                                    oninput="updateSubmitButton()"
                                />
                                <button type="button" class="discount-toggle" onclick="toggleDiscount(this)">+ Rabais</button>
                            </div>
                            <input
                                name="lines[${newIndex}][quantity]"
                                type="number"
                                step="0.01"
                                min="0.01"
                                placeholder="1"
                                onchange="updateLineTotal(this)"
                            />
                            <input
                                name="lines[${newIndex}][unit_price_ht]"
                                type="number"
                                step="0.01"
                                min="0.01"
                                placeholder="0.00"
                                onchange="updateLineTotal(this)"
                            />
                            <select name="lines[${newIndex}][vat_rate]" onchange="onVatRateChange(this)">
                                <option value="0">0 %</option>
                                <option value="5.5">5,5 %</option>
                                <option value="10">10 %</option>
                                <option value="20" selected>20 %</option>
                            </select>
                            <div class="line-total" data-line="${newIndex}">0.00 ${currency}</div>
                            <button type="button" class="btn-remove" onclick="removeLine(this)">
                                Supprimer
                            </button>
                        </div>
                        <div class="discount-row">
                            <span class="discount-label">Rabais sur la ligne ci-dessus :</span>
                            <input
                                name="lines[${newIndex}][discount_value]"
                                type="number"
                                step="0.01"
                                min="0"
                                placeholder="0"
                                onchange="updateLineTotal(this)"
                            />
                            <select name="lines[${newIndex}][discount_type]" onchange="updateLineTotal(this)">
                                <option value="percent">%</option>
                                <option value="amount">${currency}</option>
                            </select>
                            <span class="discount-amount" data-discount="${newIndex}"></span>
                            <button type="button" class="btn-clear-discount" onclick="clearDiscount(this)" title="Supprimer le rabais">&#10005;</button>
                        </div>
                        <div class="vat-extra-row">
                            <span class="vat-extra-label">Categorie TVA :</span>
                            <select name="lines[${newIndex}][vat_category]" class="category-select" onchange="onCategoryChange(this)">
                                <option value="Z">Z - Taux zero</option>
                                <option value="E">E - Exonere de TVA</option>
                                <option value="AE">AE - Autoliquidation</option>
                                <option value="G">G - Export hors UE</option>
                                <option value="K">K - Intracommunautaire</option>
                                <option value="O">O - Hors champ TVA</option>
                            </select>
                            <select name="lines[${newIndex}][vat_exemption_code]" class="vatex-select" style="display:none;" onchange="onVatexChange(this)">
                                <option value="">-- Code VATEX --</option>
                            </select>
                            <input type="text" name="lines[${newIndex}][vat_exemption_reason]" class="reason-input" placeholder="Motif d'exoneration" style="display:none;" />
                        </div>
                    </div>
                `;

                lines.insertAdjacentHTML("beforeend", lineHtml);
            }

            function removeLine(btn) {
                const lines = document.getElementById("lines");
                if (lines.children.length > 1) {
                    btn.closest(".line-wrapper").remove();
                    updateTotals();
                } else {
                    alert("La facture doit contenir au moins une ligne");
                }
            }

            function toggleDiscount(btn) {
                const wrapper = btn.closest(".line-wrapper");
                const discountRow = wrapper.querySelector(".discount-row");
                const isVisible = discountRow.classList.contains("visible");

                if (isVisible) {
                    discountRow.classList.remove("visible");
                    btn.textContent = "+ Rabais";
                } else {
                    discountRow.classList.add("visible");
                    btn.textContent = "- Rabais";
                }
            }

            function clearDiscount(btn) {
                const wrapper = btn.closest(".line-wrapper");
                const discountInput = wrapper.querySelector(
                    '[name*="discount_value"]',
                );
                const discountType = wrapper.querySelector(
                    '[name*="discount_type"]',
                );

                discountInput.value = "";
                discountType.value = "percent";

                updateLineTotal(discountInput);

                const discountRow = wrapper.querySelector(".discount-row");
                discountRow.classList.remove("visible");
                wrapper.querySelector(".discount-toggle").textContent =
                    "+ Rabais";
            }

            function updateLineTotal(input) {
                const wrapper = input.closest(".line-wrapper");
                const lineId = wrapper.dataset.id;

                const qty =
                    parseFloat(
                        wrapper.querySelector('[name*="quantity"]').value,
                    ) || 0;
                const price =
                    parseFloat(
                        wrapper.querySelector('[name*="unit_price_ht"]').value,
                    ) || 0;
                const discountValue =
                    parseFloat(
                        wrapper.querySelector('[name*="discount_value"]').value,
                    ) || 0;
                const discountType = wrapper.querySelector(
                    '[name*="discount_type"]',
                ).value;

                const grossHt = qty * price;

                let discountAmount = 0;
                if (discountValue > 0) {
                    if (discountType === "percent") {
                        discountAmount = grossHt * (discountValue / 100);
                    } else {
                        discountAmount = discountValue;
                    }
                }

                const netHt = Math.max(0, grossHt - discountAmount);

                wrapper.querySelector(`[data-line="${lineId}"]`).textContent =
                    netHt.toFixed(2) + " " + currency;

                const discountDisplay = wrapper.querySelector(
                    `[data-discount="${lineId}"]`,
                );
                if (discountAmount > 0) {
                    discountDisplay.textContent =
                        "-" + discountAmount.toFixed(2) + " " + currency;
                } else {
                    discountDisplay.textContent = "";
                }

                updateTotals();
            }

            function hasAtLeastOneValidLine() {
                const wrappers = document.querySelectorAll(".line-wrapper");
                for (const wrapper of wrappers) {
                    const desc = (wrapper.querySelector('[name*="description"]').value || "").trim();
                    const qty = parseFloat(wrapper.querySelector('[name*="quantity"]').value) || 0;
                    const price = parseFloat(wrapper.querySelector('[name*="unit_price_ht"]').value) || 0;
                    if (desc && qty > 0 && price > 0) return true;
                }
                return false;
            }

            function updateSubmitButton() {
                const btn = document.getElementById("btnSubmit");
                const wrap = document.getElementById("submitWrapper");
                if (hasAtLeastOneValidLine()) {
                    btn.disabled = false;
                    btn.style.pointerEvents = "";
                    btn.style.opacity = "1";
                    wrap.style.cursor = "";
                    wrap.title = "";
                } else {
                    btn.disabled = true;
                    btn.style.pointerEvents = "none";
                    btn.style.opacity = "0.5";
                    wrap.style.cursor = "not-allowed";
                    wrap.title = "Une ligne est obligatoire !!!";
                }
            }

            function updateTotals() {
                let totalHt = 0;
                let totalVat = 0;

                const vatByRate = {};

                document
                    .querySelectorAll(".line-wrapper")
                    .forEach((wrapper) => {
                        const qty =
                            parseFloat(
                                wrapper.querySelector('[name*="quantity"]')
                                    .value,
                            ) || 0;
                        const price =
                            parseFloat(
                                wrapper.querySelector('[name*="unit_price_ht"]')
                                    .value,
                            ) || 0;
                        const vatRate =
                            parseFloat(
                                wrapper.querySelector('[name*="vat_rate"]')
                                    .value,
                            ) || 0;
                        const discountValue =
                            parseFloat(
                                wrapper.querySelector(
                                    '[name*="discount_value"]',
                                ).value,
                            ) || 0;
                        const discountType = wrapper.querySelector(
                            '[name*="discount_type"]',
                        ).value;

                        let category = 'S';
                        if (vatRate === 0) {
                            const catSelect = wrapper.querySelector('.category-select');
                            category = catSelect ? catSelect.value : 'Z';
                        }

                        const grossHt = qty * price;

                        let discountAmount = 0;
                        if (discountValue > 0) {
                            if (discountType === "percent") {
                                discountAmount =
                                    grossHt * (discountValue / 100);
                            } else {
                                discountAmount = discountValue;
                            }
                        }

                        const netHt = Math.max(0, grossHt - discountAmount);
                        const lineVat = netHt * (vatRate / 100);

                        totalHt += netHt;
                        totalVat += lineVat;

                        const rateKey = vatRate + '_' + category;
                        if (netHt > 0) {
                            if (!vatByRate[rateKey]) {
                                vatByRate[rateKey] = {
                                    rate: vatRate,
                                    category: category,
                                    baseHt: 0,
                                    vatAmount: 0,
                                };
                            }
                            vatByRate[rateKey].baseHt += netHt;
                            vatByRate[rateKey].vatAmount += lineVat;
                        }
                    });

                const totalTtc = totalHt + totalVat;

                const vatBody = document.getElementById("vat-breakdown-body");
                const rates = Object.keys(vatByRate).sort(
                    (a, b) => vatByRate[b].rate - vatByRate[a].rate,
                );

                if (rates.length === 0) {
                    vatBody.innerHTML =
                        '<tr><td colspan="3" class="vat-table-empty">Aucune ligne saisie</td></tr>';
                } else {
                    let html = "";
                    rates.forEach((rateKey) => {
                        const data = vatByRate[rateKey];
                        let rateLabel = data.rate === 5.5 ? "5,5 %" : data.rate + " %";
                        if (data.category !== 'S') {
                            rateLabel += ` (${data.category})`;
                        }
                        html += `<tr>
                            <td class="vat-rate">${rateLabel}</td>
                            <td>${data.baseHt.toFixed(2)} ${currency}</td>
                            <td>${data.vatAmount.toFixed(2)} ${currency}</td>
                        </tr>`;
                    });
                    vatBody.innerHTML = html;
                }

                document.getElementById("total-ht").textContent =
                    totalHt.toFixed(2) + " " + currency;
                document.getElementById("total-vat").textContent =
                    totalVat.toFixed(2) + " " + currency;
                document.getElementById("total-ttc").textContent =
                    totalTtc.toFixed(2) + " " + currency;

                updateSubmitButton();
            }

            function displaySuccess(message) {
                clearErrors();
                const container = document.getElementById("successContainer");
                document.getElementById("successMessage").textContent = message;
                container.style.display = "block";
            }

            document.getElementById("invoiceForm").onsubmit = async (e) => {
                e.preventDefault();
                clearErrors();

                const formData = new FormData(e.target);

                try {
                    const response = await fetch("/invoice", {
                        method: "POST",
                        body: formData,
                    });

                    const data = await response.json();

                    if (!response.ok || !data.success) {
                        displayErrors(data.errors);
                        return;
                    }

                    window.location.href = data.redirect;
                } catch (error) {
                    displayErrors([
                        {
                            field: "_form",
                            message:
                                "Erreur de communication: " + error.message,
                        },
                    ]);
                }
            };
        </script>
{% endblock %}
